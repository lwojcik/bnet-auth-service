image: Ubuntu2004
platform: x64
stack: node lts/*
services:
  - docker

install:
  - npm install

build_script:
  - npm run build
  - docker build -t "${DOCKER_TAG}" . --no-cache

test_script:
  - npx codecov

after_build:
  - if "%APPVEYOR_REPO_BRANCH%"=="master" docker login "${DOCKER_REGISTRY}" -u "{$DOCKER_USER}" -p "${DOCKER_PASSWORD}"
  - if "%APPVEYOR_REPO_BRANCH%"=="master" docker push "${DOCKER_TAG}"